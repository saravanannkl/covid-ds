<!DOCTYPE html>
<html>
  <head>
    <title>State</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" /> 
    <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/all.css'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/fontawesome.css'>
    <link rel="stylesheet" href="graphs.css">
  </head>
  <body>
    <div class="column">
      <div class="row">
        <div style="display: flex; justify-content: space-evenly;">
        <div id="card" style="display: flex; flex-wrap: wrap;">
          <i class="fas fa-building fa-3x center"></i>
          <div class="break"></div>
           <h7><b>Sites Conducting Vaccination : </b></h7>  
           <h7 id="scvtotal" style="font-size: medium;"></h7>
           <br>
           <div class="break"></div>
           <b><h7>Goverment : </h7> </b>
           <div id="scvGovt"></div>
           <div class="break"></div>
          <b><h7>Private : </h7></b>  
          <div id="scvPvt"></div>
           <script>
              var stateValue = document.getElementById("stateselect").value;
              fetch('http://localhost:8001/covid-ds/states.json?_sort=id&name__exact='+stateValue.split(' ').join('+')+'&_shape=array')
              .then((response) => response.json())
              .then((resultdata) => {
                state_id = resultdata[0]['id'];
              fetch("http://localhost:8001/covid-ds.json?sql=select+*+from+raw_vaccination_site_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_vaccination_site_count%29a+where+location_type+%3D+%22state%22+and+location_id%3D"+state_id+"+and+r.date+%3D+a.max_date++order+by+date+limit+1")
              .then((response2) => response2.json())
                  .then((data) => {

                    values = data["rows"][0];
                    document.getElementById('scvtotal').innerHTML = values[0];
                    document.getElementById('scvGovt').innerHTML = values[1];
                    document.getElementById('scvPvt').innerHTML = values[2];
                      
              })
            })
           </script>
        </div>
        
      
        <div id="card" style="display: flex; flex-wrap: wrap; ">
          <i class="fas fa-syringe fa-3x center"></i>
          <div class="break"></div>
          <h7><b>Total Vaccinations : </b></h7> 
          <h7 id="tvtotal" style="font-size: medium;"></h7>
          <div class="break"></div>
           <b><h7>Dose 1:</h7> </b>
           <div id="d1"></div>
           <div class="break"></div>
          <b><h7>Dose 2:</h7></b>  
          <div id="d2"></div>
          <div class="break"></div>
          <script>
             var stateValue = document.getElementById("stateselect").value;
              fetch('http://localhost:8001/covid-ds/states.json?_sort=id&name__exact='+stateValue.split(' ').join('+')+'&_shape=array')
              .then((response) => response.json())
              .then((resultdata) => {
                state_id = resultdata[0]['id'];
                  fetch("http://localhost:8001/covid-ds.json?sql=select+*+from+raw_vaccination_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_vaccination_count%29a+where+r.date+%3D+a.max_date+and+location_type%3D%22state%22+and+location_id%3D"+state_id+"+order+by+date+limit+1")
                  .then((response) => response.json())
                    .then((data) => {
                      values = data["rows"][0];
                      document.getElementById('tvtotal').innerHTML = values[9];
                      document.getElementById('d1').innerHTML = values[7];
                      document.getElementById('d2').innerHTML = values[8];
                        
                })
              })
          </script>
       </div>
      </div>
      </div>
      <div class="row">
        <div id="card">
        <h4>Total Vaccinated</h4>
        <div class="container-outer">
          <div class="container-inner">
        <div id="state_vaccination_count"></div>
        </div>
        </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div style="display: flex;justify-content: space-evenly;">
        <div id="card">
          <h4>Vaccination by age</h4>
          <div id="vaccination_by_age"></div>
        </div> 
        <div id="card">
          <h4>Vaccine Data</h4>
          <div id="vaccine_data"></div>
        </div> 
        </div>
      </div>
      <br>
      <div class="row">
        <div id="card">
          <h4>District Vaccination</h4>
          <div class="container-outer">
            <div class="container-inner">
              <div id="district_vaccination_count"></div>
            </div>  
          </div>    
      </div>
      </div>
      <div class="row">
        <div style="display: flex; justify-content: space-evenly;">
        <div id="card">
          <h4>Aefi Chart</h4>
          <div id="aefi_chart"></div>
        </div>
        <div id="card">
          <h4>Session Trend</h4>
          <div id="session_trend"></div>
        </div>
      </div>
      </div>
    </div>
  <script type="text/javascript">
    var state = document.getElementById("stateselect").value;
    state = state.split(' ').join('+');
   
    var state_vaccination_count = { 
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "http://localhost:8001/covid-ds/raw_state_level_vaccination_count.json?state_name__exact="+state+"&_shape=array"
          },
          width:800,
      height:300,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "today", type: "quantitative", title:"vaccinated"},
        color:{value:"#00CED1"}
        },
        layer: [
          {
            mark:{
              type:"line",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "today", type: "quantitative", title:"vaccinated"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]};
    vegaEmbed('#state_vaccination_count', state_vaccination_count);
    var vaccination_by_age = {    
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",
          height:200,
          width:400,
          data: {
            url: "http://localhost:8001/covid-ds/final_state_vaccination_age.json?state_name__exact="+state+"&_shape=array"
          },
          mark: "arc",
          encoding: {
            theta: {field: "state", type: "quantitative", stack: true},
            color: {field: "type", type: "nominal"}
          },
          layer: [{
          mark: {type: "arc", outerRadius: 80}
          }, 
          {
          mark: {type: "text", radius: 110},
          encoding: {
            text: {field: "state", type: "quantitative"}
          }
          }],
          view: {stroke: null}
          };
    vegaEmbed('#vaccination_by_age', vaccination_by_age);
    var vaccine_data = {
            $schema: "https://vega.github.io/schema/vega-lite/v5.json",
            height:200,
            width:400,
            data: {
              url: "http://localhost:8001/covid-ds/state_vaccine_data.json?state_name__exact="+state+"&_shape=array"
            },
              mark: { type:"arc",
                    innerRadius: 50
            },
            encoding: {
              theta: {field: "state", type: "quantitative", stack: true},
              color: {field: "type", type: "nominal"}
            },
            layer: [{
            mark: {type: "arc", outerRadius: 80, innerRadius: 50}
            }, {
            mark: {type: "text", radius: 110},
            encoding: {
              text: {field: "state", type: "quantitative"}
            }
            }],
            view: {stroke: null}
            };
    vegaEmbed('#vaccine_data', vaccine_data);
    var stateName = document.getElementById("stateselect").value;
    var district_vaccination_count = { 
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "/covid-ds.json?sql=select+*+from+raw_district_level_vaccination_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_district_level_vaccination_count%29a+where+r.date+%3D+a.max_date+and+state_name%3D%22"+stateName.split(' ').join('+')+"%22++order+by+date+limit+1000&_shape=array&_shape=array",
            format: {type: "json"}
          },
          transform: [
            {
              calculate: "\n          'district name: ' + datum['district_name'] +\n          ', total: ' + datum['total'] +\n          (false ? ', : ' + datum[''] : '') +\n          (false ? ', : ' + datum[''] : '')\n        ",
              as: "_tooltip_summary"
            }
          ],  
          mark: "bar",
          encoding: {
            x: {field: "district_name", type: "ordinal", bin: false},
            y: {field: "total", type: "quantitative", bin: false},
            color:{value:'#B22222'},
            tooltip: {field: "_tooltip_summary", type: "ordinal"}
          }
    }
    vegaEmbed('#district_vaccination_count', district_vaccination_count);
      var state_Name = document.getElementById("stateselect").value;                   
    var aefi_chart ={
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url:"/covid-ds.json?sql=select+*+from+raw_meta+where+date+in+%28select+date+from+raw_meta+where+%22location_id%22+%3D+%3Ap0+and+%22location_type%22+%3D+%3Ap1+order+by+date+DESC+limit+7%29+and+%22location_id%22+%3D+%3Ap0+and+%22location_type%22+%3D+%3Ap1+order+by+date%0D%0A&p0="+stateID+"&p1=state&_shape=array&_shape=array"
                        
          },
          width:400,
      height:200,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "aefiPercentage", type: "quantitative"},
        color: {value: "#e75480"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "aefiPercentage", type: "quantitative"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]
    };
    vegaEmbed('#aefi_chart', aefi_chart);
    var session_trend ={
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "/covid-ds.json?sql=select+date%2CSUM%28count%29+as+completed+from+raw_session_vaccination_count+where+date+in+%28select+DISTINCT+date+from+raw_session_vaccination_count+where+location_id%3D"+stateID+"+and+location_type%3D%22state%22+order+by+date+DESC+limit+7%29+and+location_id%3D"+stateID+"+and+location_type%3D%22state%22+group+by+date&_shape=array&_shape=array"
          },
       width:400,
       height:200,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "completed", type: "quantitative"},
        color: {value: "#8A2BE2"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "completed", type: "quantitative"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]
    };
    vegaEmbed('#session_trend', session_trend);
    
  </script>
  </body>
</html>