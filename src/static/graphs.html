<!DOCTYPE html>
<html>
  <head>
    <title>Graphs</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" /> 
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/all.css'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/fontawesome.css'>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <link rel="stylesheet" href="graphs.css">  
    
  </head>
  <body>
    <div class="column">
      <div class="row">
        <div style="display: flex;">
        <div id="card" style="display: flex; flex-wrap: wrap;">
          <i class="fas fa-building fa-3x center"></i>
          <div class="break"></div>
           <h7><b>Sites Conducting Vaccination : </b></h7>  
           <h7 id="scvtotal" style="font-size: medium;"></h7>
           <br>
           <div class="break"></div>
           <b><h7>Goverment : </h7> </b>
           <div id="scvGovt"></div>
           <div class="break"></div>
          <b><h7>Private : </h7></b>  
          <div id="scvPvt"></div>
           <script>
             fetch("http://localhost:8001/covid-ds.json?sql=select+*+from+raw_vaccination_site_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_vaccination_site_count%29a+where+%22location_type%22+%3D+%22national%22+and+r.date+%3D+a.max_date++order+by+date+limit+1")
             .then((response) => response.json())
                .then((data) => {
  	              
                  console.log(data["rows"]);
                  values = data["rows"][0];
                  document.getElementById('scvtotal').innerHTML = values[0];
                  document.getElementById('scvGovt').innerHTML = values[1];
                  document.getElementById('scvPvt').innerHTML = values[2];
                    
            })
           </script>
        </div>
        
        <div id="card" style="display: flex; flex-wrap: wrap;">
          <i class="fas fa-users fa-3x center"></i>
          <div class="break"></div>
           <h7><b>Total Registrations: </b></h7> 
           <h7 id="trtotal" style="font-size: medium;"></h7>
           <div class="break"></div>
           <b><h7>Male:</h7> </b><br>
           <div id="male"></div>
           <div class="break"></div>
          <b><h7>Female:</h7></b>  <br>
          <div id="female"></div>
          <div class="break"></div>
          <b><h7>Others:</h7></b>  <br>
          <div id="others"></div>
           <script>
             fetch("http://localhost:8001/covid-ds.json?sql=select+*+from+raw_registration_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_registration_count%29a+where+r.date+%3D+a.max_date++order+by+date+limit+1")
             .then((response) => response.json())
                .then((data) => {
                  values = data["rows"][0];
                  document.getElementById('trtotal').innerHTML = values[0];
                  document.getElementById('male').innerHTML = values[1];
                  document.getElementById('female').innerHTML = values[2];
                  document.getElementById('others').innerHTML = values[3];
                    
            })
           </script>
        </div>
        <div id="card" style="display: flex; flex-wrap: wrap;">
          <i class="fas fa-syringe fa-3x center"></i>
          <div class="break"></div>
          <h7><b>Total Vaccinations : </b></h7> 
          <h7 id="tvtotal" style="font-size: medium;"></h7>
          <div class="break"></div>
           <b><h7>Dose 1:</h7> </b>
           <div id="d1"></div>
           <div class="break"></div>
          <b><h7>Dose 2:</h7></b>  
          <div id="d2"></div>
          <div class="break"></div>
          <script>
            fetch("http://localhost:8001/covid-ds.json?sql=select+*+from+raw_vaccination_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_vaccination_count%29a+where+r.date+%3D+a.max_date+and+location_type%3D%22national%22+order+by+date+limit+1")
            .then((response) => response.json())
               .then((data) => {
                 values = data["rows"][0];
                 document.getElementById('tvtotal').innerHTML = values[9];
                 document.getElementById('d1').innerHTML = values[7];
                 document.getElementById('d2').innerHTML = values[8];
                   
           })
          </script>
       </div>
      </div>
      </div>
     
    <div class="row">
      <div id="card">
        <h4>Vaccination Trend</h4>
        <div class="container-outer">
          <div class="container-inner">
        <div id="vaccination_trend"></div>
        </div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div style="display: flex; justify-content: space-evenly;">
      <div id="card">
          <h4>Vaccination by Age</h4>
          <div id="vaccination_by_age"></div>        
      </div>
      <div id="card">
        <h4>Vaccine Data</h4>
        <div id="vaccine_data"></div>
      </div>
    </div>
    </div>
    <br>
    <div class="row">
      <div id="card">
        <h4>Total Vaccinated(State Wise)</h4>
        <div id="state_vaccination_count"></div>
        
      </div>
      </div>
      <br>
    <div class="row">
      <div style="display: flex; justify-content: space-evenly;">
      <div id="card">
        <h4>Aefi Data</h4>
        <div id="aefi_chart"></div>
      </div>
      <div id="card">
        <h4>Session Trend</h4>
        <div id="session_trend"></div>
      </div>
    </div>
  </div>
    <div class="row">
      <div id="card">
        <h4>Registration Trend</h4>
        <div class="container-outer">
          <div class="container-inner">
        <div id="registration_trend"></div>  
        </div>
        </div>
      </div>    
    </div>
    </div>
  <script type="text/javascript">
    var vaccination_trend = {  
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      data: {
        url:"http://localhost:8001/covid-ds/national_vaccine_trend.json?_shape=array"
      },
      width:800,
      height:300,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
            color: {
          field: "type",
          type: "nominal"

        },
        y: {field: "national", type: "quantitative"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
          transform: [{pivot: "type", value: "national", groupby: ["date"]}],
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "Dose 1", type: "quantitative"},
              {field: "Dose 2", type: "quantitative"},
              {field: "today", type: "quantitative"}
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]};
    

    var vaccination_by_age = {    
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",
          height:200,
          width:400,
          data: {
            url: "http://localhost:8001/covid-ds/final_vaccination_age.json?_shape=array"
          },
          mark: "arc",
          encoding: {
            theta: {field: "national", type: "quantitative", stack: true},
            color: {field: "type", type: "nominal"}
          },
          layer: [{
          mark: {type: "arc", outerRadius: 80}
          }, 
          {
          mark: {type: "text", radius: 110},
          encoding: {
            text: {field: "national", type: "quantitative"}
          }
          }],
          view: {stroke: null}
          };
    
    var vaccine_data = {
            $schema: "https://vega.github.io/schema/vega-lite/v5.json",
            height:200,
            width:400,
            data: {
              url: "http://localhost:8001/covid-ds/vaccine_data.json?_shape=array"
            },
              mark: { type:"arc",
                    innerRadius: 50
            },
            encoding: {
              theta: {field: "national", type: "quantitative", stack: true},
              color: {field: "type", type: "nominal"}
            },
            layer: [{
            mark: {type: "arc", outerRadius: 80, innerRadius: 50}
            }, {
            mark: {type: "text", radius: 110},
            encoding: {
              text: {field: "national", type: "quantitative"}
            }
            }],
            view: {stroke: null}
            };
    
    var state_vaccination_count = { 
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "/covid-ds.json?sql=select+*+from+raw_state_level_vaccination_count+r+INNER+JOIN+%28SELECT+MAX%28date%29+as+max_date+FROM+raw_state_level_vaccination_count%29a+where+r.date+%3D+a.max_date++order+by+date+limit+37%0D%0A&_shape=array&_shape=array",
            format: {type: "json"}
          },
          transform: [
              {
                calculate: "\n          'state name: ' + datum['state_name'] +\n          ', total: ' + datum['total'] +\n          (false ? ', : ' + datum[''] : '') +\n          (false ? ', : ' + datum[''] : '')\n        ",
                as: "_tooltip_summary"
              }
            ],
          mark: "bar",
          encoding: {
            x: {field: "state_name", type: "ordinal", bin: false, title:"state"},
            y: {field: "total", type: "quantitative", bin: false},
            color:{value:'#00FFFF'},
            tooltip: {field: "_tooltip_summary", type: "ordinal"}
          }
    }
    
  
    var aefi_chart ={
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "/covid-ds.json?sql=select+*+from+raw_meta+where+date+in+%28select+date+from+raw_meta+where+%22location_id%22+%3D+%3Ap0+and+%22location_type%22+%3D+%3Ap1+order+by+date+DESC+limit+7%29+and+%22location_id%22+%3D+%3Ap0+and+%22location_type%22+%3D+%3Ap1+order+by+date%0D%0A&p0=0&p1=national&_shape=array&_shape=array"
          },
          width:400,
      height:200,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "aefiPercentage", type: "quantitative"},
        color: {value: "#e75480"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "aefiPercentage", type: "quantitative"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]
    };
    var session_trend ={
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "/covid-ds.json?sql=select+date%2CSUM%28count%29+as+completed+from+raw_session_vaccination_count+where+date+in+%28select+DISTINCT+date+from+raw_session_vaccination_count+where+location_id%3D0+and+location_type%3D%22national%22+order+by+date+DESC+limit+7%29+and+location_id%3D0+and+location_type%3D%22national%22+group+by+date&_shape=array&_shape=array"
          },
       width:400,
       height:200,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "completed", type: "quantitative"},
        color: {value: "#8A2BE2"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "completed", type: "quantitative"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]
    };
    var registration_trend ={
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",   
          data: {
            url: "http://localhost:8001/covid-ds/raw_registration_count.json?_shape=array"
          },
          width:400,
      height:200,
      encoding: {x: {field: "date", type: "nominal"}},
      layer: [
        {
          encoding: {
        y: {field: "today", type: "quantitative"},
        color: {value: "#D2691E"}
        },
        layer: [
          {
            mark:{
              type:"area",
              point: {
              filled: false,
              fill: "white"
                } 
              }
            },
            {transform: [{filter: {param: "hover", empty: false}}], mark: "point"}
          ]
        },
        {
         
          mark:{
            type: "rule"
            
          },
          encoding: {
            opacity: {
              condition: {value: 0.3, param: "hover", empty: false},
              value: 0
            },
            tooltip: [
              {field: "today", type: "quantitative"},
            ]
          },
          params: [{
            name: "hover",
            select: {
              type: "point",
              fields: ["date"],
              nearest: true,
              on: "mouseover",
              clear: "mouseout"
            }
          }]
        }]
    };
    
    vegaEmbed('#state_vaccination_count', state_vaccination_count);
    vegaEmbed('#vaccination_trend', vaccination_trend);
    vegaEmbed('#vaccination_by_age', vaccination_by_age);
    vegaEmbed('#vaccine_data', vaccine_data);
    vegaEmbed('#aefi_chart', aefi_chart);
    vegaEmbed('#session_trend', session_trend);
    vegaEmbed('#registration_trend', registration_trend);
  </script>
  </body>
</html>